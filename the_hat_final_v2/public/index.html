<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hat - ุฐุง ูุงุช</title>
    <link rel="stylesheet" href="style.css">
    <!-- ููุชุจุฉ Socket.io ุนุดุงู ุงูุงุชุตุงู ุงููุจุงุดุฑ -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <header>
        <div class="logo-container">
            <!-- ุงููููู ุญูู ูุง ูุญุด -->
            <img src="./logo.webp" alt="The Hat Logo" class="logo-img" onerror="this.style.display='none'; document.querySelector('.logo-container').innerText='THE HAT'">
        </div>
        <h1>THE HAT | ุฐุง ูุงุช</h1>
    </header>

    <div class="container">

        <!-- ================= ุตูุญุฉ ุงุฎุชูุงุฑ ุงููุฑุน ================= -->
        <div id="branch-page" class="page active">
            <h2 style="text-align: center; margin-bottom: 20px; color: #aaa;">ุงุฎุชุฑ ุงููุฑุน ุงูุฃูุฑุจ ูู</h2>
            
            <div class="branch-card" style="margin-bottom: 20px;">
                <button class="btn" onclick="selectBranch('okaz')">ูุฑุน ุนูุงุธ</button>
            </div>
            
            <div class="branch-card">
                <button class="btn" onclick="selectBranch('halqa')">ูุฑุน ุงูุญููุฉ</button>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <p style="color: #666; font-size: 0.9rem;">ููุธูุ</p>
                <button onclick="showPage('admin-login')" style="background: none; border: none; color: #444; text-decoration: underline; cursor: pointer;">ุฏุฎูู ุงููุทุจุฎ</button>
            </div>
        </div>

        <!-- ================= ุตูุญุฉ ุงููููู ================= -->
        <div id="menu-page" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="selected-branch-title">ุงููููู</h2>
                <button onclick="showPage('branch-page')" style="background: none; border: none; color: #aaa; cursor: pointer;">ุชุบููุฑ ุงููุฑุน</button>
            </div>

            <div id="menu-items">
                <!-- ุงูุฃุตูุงู ุจุชูุฒู ููุง ุจุงูุฌุงูุงุณูุฑูุจุช -->
            </div>

            <!-- ุงูุณูุฉ ุงูุนุงุฆูุฉ -->
            <div id="cart-float" class="cart-float" style="display: none;" onclick="showPage('checkout-page')">
                <span id="cart-count">0 ููุชุฌุงุช</span>
                <span id="cart-total">0 ุฑูุงู</span>
                <span>ุฅุชูุงู ุงูุทูุจ &larr;</span>
            </div>
        </div>

        <!-- ================= ุตูุญุฉ ุงูุฏูุน ูุฅููุงู ุงูุทูุจ ================= -->
        <div id="checkout-page" class="page">
            <button onclick="showPage('menu-page')" class="btn btn-secondary" style="margin-bottom: 20px;">&rarr; ุฑุฌูุน ูููููู</button>
            
            <h2 style="margin-bottom: 20px; color: var(--accent-color);">ููุฎุต ุงูุทูุจ</h2>
            <div id="checkout-items" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- ุชูุงุตูู ุงูุณูุฉ ููุง -->
            </div>

            <h3 style="margin-bottom: 15px;">ุจูุงูุงุชู ูุง ุบุงูู</h3>
            <form id="order-form" onsubmit="submitOrder(event)">
                <div class="form-group">
                    <label>ุงูุงุณู ุงููุฑูู</label>
                    <input type="text" id="customer-name" required placeholder="ูุซูุงู: ูุญูุฏ ุงูุนุชูุจู">
                    <small id="name-error" style="color: var(--danger-color); display: none;">ุงูุงุณู ูุทููุจ ูุง ุบุงูู</small>
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงูุฌูุงู (ูุงุฒู ูุจุฏุฃ ุจู 05 ููููู 10 ุฃุฑูุงู)</label>
                    <input type="tel" id="customer-phone" required placeholder="05xxxxxxxx" maxlength="10">
                    <small id="phone-error" style="color: var(--danger-color); display: none;">ุฑูู ุงูุฌูุงู ูุงุฒู ูุจุฏุฃ ุจู 05 ููููู 10 ุฃุฑูุงู</small>
                </div>
                <div class="form-group">
                    <label>ููุน ูููุฏูู ุงูุณูุงุฑุฉ (ุนุดุงู ูุนุฑูู)</label>
                    <input type="text" id="car-info" required placeholder="ูุซูุงู: ูุงูุฑู ุจูุถุงุก 2020">
                </div>
                
                <button type="submit" id="submit-btn" class="btn">
                    <span id="btn-text">ุชุฃููุฏ ุงูุทูุจ (ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู)</span>
                    <span id="btn-loader" style="display: none;">ุฌุงุฑู ุงูุฅุฑุณุงู... โณ</span>
                </button>
            </form>
        </div>

        <!-- ================= ุตูุญุฉ ุงููุงุชูุฑุฉ (ุชุชุจุน ุงูุทูุจ) ================= -->
        <div id="invoice-page" class="page">
            <div style="text-align: center; padding: 30px 0;">
                <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 10px;">&#10004;</div>
                <h2 style="color: var(--accent-color);">ุชู ุงุณุชูุงู ุทูุจู ุจูุฌุงุญ!</h2>
                <p style="color: #aaa; margin-top: 10px;">ุฑูู ุงูุทูุจ: <span id="invoice-id" style="color: white; font-weight: bold;">#</span></p>
            </div>

            <div class="order-card" style="text-align: center;">
                <p>ุญุงูุฉ ุงูุทูุจ ุงูุญุงููุฉ:</p>
                <h1 id="invoice-status" style="font-size: 2rem; margin: 15px 0; color: var(--accent-color);">ุฌุงุฑู ุงูุงูุชุธุงุฑ...</h1>
                <p style="font-size: 0.9rem; color: #888;">ุฎููู ูู ูุงูุตูุญุฉุ ุจุชุชุญุฏุซ ุชููุงุฆูุงู ููุง ูุฌูุฒ ุทูุจู</p>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">ุชูุงุตูู ุงููุงุชูุฑุฉ</h3>
                <div id="invoice-details"></div>
                <div style="margin-top: 15px; font-weight: bold; font-size: 1.2rem; text-align: left;">
                    ุงููุฌููุน: <span id="invoice-total" style="color: var(--accent-color);">0</span> ุฑูุงู
                </div>
            </div>
            
            <button onclick="location.reload()" class="btn btn-secondary" style="margin-top: 30px;">ุทูุจ ุฌุฏูุฏ</button>
        </div>

        <!-- ================= ุตูุญุฉ ุฏุฎูู ุงูุฃุฏูู ================= -->
        <div id="admin-login" class="page">
            <h2 style="text-align: center; margin-bottom: 20px;">ุฏุฎูู ุงููุทุจุฎ / ุงููุงุดูุฑ</h2>
            <div class="form-group">
                <label>ุงูุฑูุฒ ุงูุณุฑู</label>
                <input type="password" id="admin-pin" placeholder="ุฃุฏุฎู ุงูุฑูุฒ" style="text-align: center; letter-spacing: 5px; font-size: 1.5rem;">
            </div>
            <button onclick="checkAdminPin()" class="btn">ุฏุฎูู</button>
            <button onclick="showPage('branch-page')" class="btn btn-secondary">ุฑุฌูุน</button>
        </div>

        <!-- ================= ุตูุญุฉ ููุญุฉ ุงูุชุญูู (ุงููุทุจุฎ) ================= -->
        <div id="admin-dashboard" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <h2>๐จโ๐ณ ุงููุทุจุฎ (ุงูุทูุจุงุช ุงูุญูุฉ)</h2>
                <div>
                    <button onclick="enableSound()" id="sound-btn" style="background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 5px;">๐ ุชูุนูู ุงูุตูุช</button>
                    <button onclick="showPage('branch-page')" style="background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px;">ุฎุฑูุฌ</button>
                </div>
            </div>

            <div id="admin-orders-list">
                <p style="text-align: center; color: #666; margin-top: 50px;">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู...</p>
            </div>
        </div>

    </div>

    <!-- ููุฏุงู ุงุฎุชูุงุฑ ุงููููุน -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; color: var(--accent-color);">ุชูุฌูู ูููุฑุน</h3>
            <p style="margin-bottom: 20px;">ุชุจู ููุชุญ ูู ูููู ูุงุจ ููุง ุชุฏู ุงูุทุฑููุ</p>
            <button id="maps-btn" class="btn">ูุฏูู ูููููุน (Google Maps)</button>
            <button onclick="closeModalAndGoToMenu()" class="btn btn-secondary">ุฃุนุฑู ุงููููุนุ ููู ุงูุทูุจ</button>
        </div>
    </div>

    <!-- ุตูุช ุงูุชูุจูู (ูุฎูู) -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= ุงูุจูุงูุงุช (ุงููููู ุงูุฌุฏูุฏ - ุงููุณุฎุฉ ุงูููุงุฆูุฉ) =================
        const menuItems = [
            // 1. ูุณู ุงููุฌุจุงุช ูุงูุณุงูุฏูุชุดุงุช
            { id: 1, name: "ูุงุช ูุฌุจุฉ ูุญู (950 cal)", price: 23, category: "ูุฌุจุงุช" },
            { id: 2, name: "ูุงุช ูุฌุจุฉ ุฏุฌุงุฌ (830 cal)", price: 21, category: "ูุฌุจุงุช" },
            { id: 3, name: "ูุงุช ุดูุณ ูุญู (490 cal)", price: 16, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 4, name: "ูุงุช ุดูุณ ุฏุฌุงุฌ (400 cal)", price: 14, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 5, name: "ูุงุช ุจุฑุฌุฑ ูุญู (450 cal)", price: 14, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 6, name: "ูุงุช ุจุฑุฌุฑ ุฏุฌุงุฌ (360 cal)", price: 12, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 7, name: "ูุงุช ุณุชูู (ูุญู/ุฏุฌุงุฌ)", price: 13, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 8, name: "ูุงุช ุณุชูู ูุฌุจุฉ", price: 23, category: "ูุฌุจุงุช" },
            { id: 9, name: "ูุงุช ุญุณูู (350 cal)", price: 16, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 10, name: "ูุงุช ุญุณูู ูุฌุจุฉ", price: 18, category: "ูุฌุจุงุช" },
            { id: 11, name: "ูุงุช ุณุจูุดู ุญุณูู (390 cal)", price: 18, category: "ุณุงูุฏูุชุดุงุช" },

            // 2. ูุณู ูุงุช ุจุทุงุทุณ
            { id: 12, name: "ุจุทุงุทุณ ููุฏุฌุฑ (200 cal)", price: 9, category: "ุจุทุงุทุณ" },
            { id: 13, name: "ุจุทุงุทุณ ุจุงูุจุตู ุงูููุฑูุด (220 cal)", price: 11, category: "ุจุทุงุทุณ" },
            { id: 14, name: "ุจุทุงุทุณ ุจุงููุญู ุงูููุฑูู (245 cal)", price: 12, category: "ุจุทุงุทุณ" },
            { id: 15, name: "ุจุทุงุทุณ ููุนุจุงุช (200 cal)", price: 10, category: "ุจุทุงุทุณ" },
            { id: 16, name: "ุจุทุงุทุณ ุญููุฉ ูุน ุตูุต ุชูุณุงุณ (130 cal)", price: 11, category: "ุจุทุงุทุณ" },
            { id: 17, name: "ุจุทุงุทุณ ุจุงูุฏุฌุงุฌ ุงูููุฑูู (238 cal)", price: 12, category: "ุจุทุงุทุณ" },

            // 3. ูุณู ุงูุฅุถุงูุงุช ูุงูุตูุตุงุช
            { id: 18, name: "ุตูุต ุฐุง ูุงุช", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 19, name: "ุตูุต ุชูุณุงุณ", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 20, name: "ุตูุต ุฌุจู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 21, name: "ููุงุจููู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 22, name: "ุดุฑูุญุฉ ุฌุจู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 23, name: "ุจุตู ููุฑูุด", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 24, name: "ุดูุชูุณ", price: 2, category: "ุฅุถุงูุงุช" },

            // 4. ูุณู ุงููุดุฑูุจุงุช
            { id: 25, name: "ูุดุฑูุจุงุช ุบุงุฒูุฉ (ุจูุจุณูุ ุฏููุ ุณูู ุฃุจุ ููุฑูุฏุง)", price: 4, category: "ูุดุฑูุจุงุช" },
            { id: 26, name: "ูุงุก", price: 1, category: "ูุดุฑูุจุงุช" }
        ];

        const branches = {
            'okaz': 'https://maps.app.goo.gl/tDuWBrnBc27WJgiSA?g_st=ipc',
            'halqa': 'https://maps.app.goo.gl/eWtxLwmejQPABrAt5?g_st=ipc'
        };

        // ================= ุงููุชุบูุฑุงุช ุงูุนุงูุฉ =================
        let cart = [];
        let currentBranch = '';
        let socket = io(); // ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ
        let myOrderId = null; // ุนุดุงู ุงูุฒุจูู ูุนุฑู ุทูุจู
        let allOrders = []; // ูุฎุฒู ูู ุงูุทูุจุงุช ููุง ุนุดุงู ุชููู ุฌุงูุฒุฉ ูููุงุดูุฑ ูู ุฃู ููุช

        // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูุญูุฏ ุฑูู ุงูุทูุจ
        function getShortId(longId) {
            return longId.slice(-4);
        }

        // ================= ุฏูุงู ุงูุชููู ูุงููุงุฌูุฉ (ูุน ุญูุธ ุงูุญุงูุฉ ุงูููู) =================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
            
            // ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ุฏุงุฆูุงู
            localStorage.setItem('currentPage', pageId);
        }

        // ุงุณุชุฑุฌุงุน ุงูุญุงูุฉ ุนูุฏ ูุชุญ ุงูุตูุญุฉ (ุงูููุทู ุงูุฌุฏูุฏ)
        window.onload = function() {
            const savedPage = localStorage.getItem('currentPage');
            const savedOrderId = localStorage.getItem('myOrderId');
            const savedBranch = localStorage.getItem('selectedBranch');

            // 1. ูู ูุงู ุฃุฏููุ ูุฑุฌุนู ูููุทุจุฎ ููุฑุงู
            if (savedPage === 'admin-dashboard') {
                showPage('admin-dashboard');
                return;
            }

            // 2. ูู ูุงู ุฒุจูู ูุนูุฏู ุทูุจ ูุดุทุ ูุฑุฌุนู ูููุงุชูุฑุฉ ููุฑุงู
            if (savedOrderId) {
                myOrderId = savedOrderId;
                showPage('invoice-page');
                // ูุทูุจ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูู ุงูุณูุฑูุฑ
                socket.emit('check-order-status', myOrderId);
                return;
            }

            // 3. ูู ูุงู ุฒุจูู ูุงุฎุชุงุฑ ุงููุฑุน ุจุณ ูุณู ูุง ุทูุจุ ูุฑุฌุนู ูููููู
            if (savedPage === 'menu-page' && savedBranch) {
                currentBranch = savedBranch;
                document.getElementById('selected-branch-title').innerText = 
                    currentBranch === 'okaz' ? 'ูููู ูุฑุน ุนูุงุธ' : 'ูููู ูุฑุน ุงูุญููุฉ';
                renderMenu();
                showPage('menu-page');
                return;
            }

            // 4. ุบูุฑ ูุฐุงุ ูุฑูุญ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
            showPage('branch-page');
        };

        function selectBranch(branch) {
            currentBranch = branch;
            localStorage.setItem('selectedBranch', branch); // ูุญูุธ ุงููุฑุน
            
            const modal = document.getElementById('location-modal');
            const mapsBtn = document.getElementById('maps-btn');
            
            // ูุฌูุฒ ุฒุฑ ุงููุงุจ ุจุงูุฑุงุจุท ุงูุตุญ
            mapsBtn.onclick = () => {
                window.open(branches[branch], '_blank');
                closeModalAndGoToMenu();
            };
            
            modal.classList.add('active');
        }

        function closeModalAndGoToMenu() {
            document.getElementById('location-modal').classList.remove('active');
            document.getElementById('selected-branch-title').innerText = 
                currentBranch === 'okaz' ? 'ูููู ูุฑุน ุนูุงุธ' : 'ูููู ูุฑุน ุงูุญููุฉ';
            renderMenu();
            showPage('menu-page');
        }

        // ================= ุฏูุงู ุงูุณูุฉ ูุงููููู =================
        function renderMenu() {
            const container = document.getElementById('menu-items');
            
            // ุชุฌููุน ุงูุฃุตูุงู ุญุณุจ ุงููุณู
            const categories = {
                'ูุฌุจุงุช': [],
                'ุณุงูุฏูุชุดุงุช': [],
                'ุจุทุงุทุณ': [],
                'ุฅุถุงูุงุช': [],
                'ูุดุฑูุจุงุช': []
            };
            
            menuItems.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category].push(item);
                }
            });

            let html = '';
            for (const [catName, items] of Object.entries(categories)) {
                if (items.length > 0) {
                    html += `<h3 style="color: var(--accent-color); margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">${catName}</h3>`;
                    html += items.map(item => `
                        <div class="menu-item">
                            <div class="item-info">
                                <h3>${item.name}</h3>
                                <div class="item-price">${item.price} ุฑูุงู</div>
                            </div>
                            <button class="add-btn" onclick="addToCart(${item.id})">+</button>
                        </div>
                    `).join('');
                }
            }
            container.innerHTML = html;
        }

        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            cart.push(item);
            updateCartUI();
            
            // ุงูุชุฒุงุฒ ุจุณูุท ููุณูุฉ ุนุดุงู ูุญุณ ุงููุณุชุฎุฏู
            const cartFloat = document.getElementById('cart-float');
            cartFloat.style.transform = 'scale(1.1)';
            setTimeout(() => cartFloat.style.transform = 'scale(1)', 200);
        }

        function updateCartUI() {
            const count = cart.length;
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            
            document.getElementById('cart-count').innerText = `${count} ููุชุฌุงุช`;
            document.getElementById('cart-total').innerText = `${total} ุฑูุงู`;
            
            const cartFloat = document.getElementById('cart-float');
            if (count > 0) cartFloat.style.display = 'flex';
            
            // ุชุญุฏูุซ ุตูุญุฉ ุงูุฏูุน ููุงู
            renderCheckout();
        }

        function renderCheckout() {
            const container = document.getElementById('checkout-items');
            if (cart.length === 0) {
                container.innerHTML = '<p>ุณูุชู ูุงุถูุฉ ูุง ุงูุญุจูุจ</p>';
                return;
            }

            // ูุฌูุน ุงูุนูุงุตุฑ ุงููุชุดุงุจูุฉ
            const grouped = {};
            cart.forEach(item => {
                if (!grouped[item.id]) grouped[item.id] = { ...item, qty: 0 };
                grouped[item.id].qty++;
            });

            container.innerHTML = Object.values(grouped).map(item => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                    <span>${item.name} x${item.qty}</span>
                    <span>${item.price * item.qty} ุฑูุงู</span>
                </div>
            `).join('') + `
                <div style="text-align: left; font-weight: bold; margin-top: 15px; font-size: 1.2rem; color: var(--accent-color);">
                    ุงูุฅุฌูุงูู: ${cart.reduce((sum, i) => sum + i.price, 0)} ุฑูุงู
                </div>
            `;
        }

        // ================= ุฅุฑุณุงู ุงูุทูุจ =================
        function submitOrder(e) {
            e.preventDefault();
            
            // ุงูุชุญูู ูู ุงูุจูุงูุงุช
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const car = document.getElementById('car-info').value.trim();
            
            let isValid = true;

            // ุชุญูู ุงูุงุณู
            if (name.length < 2) {
                document.getElementById('name-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('name-error').style.display = 'none';
            }

            // ุชุญูู ุงูุฌูุงู (ูุจุฏุฃ ุจู 05 ูุทููู 10)
            const phoneRegex = /^05\d{8}$/;
            if (!phoneRegex.test(phone)) {
                document.getElementById('phone-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('phone-error').style.display = 'none';
            }

            if (!isValid) return;
            if (cart.length === 0) return alert('ุงูุณูุฉ ูุงุถูุฉ!');

            // ุชุดุบูู ุงูููุฏููู
            const btn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';

            const orderData = {
                customerName: name,
                customerPhone: phone,
                carInfo: car,
                branch: currentBranch,
                items: cart,
                total: cart.reduce((sum, i) => sum + i.price, 0)
            };

            // ูุฑุณู ุงูุทูุจ ููุณูุฑูุฑ
            socket.emit('new-order', orderData);
        }

        // ================= ููุญุฉ ุงูุชุญูู (ุงูุฃุฏูู) =================
        function checkAdminPin() {
            const pin = document.getElementById('admin-pin').value;
            if (pin === '1234') {
                showPage('admin-dashboard');
                // ูุนุฑุถ ุงูุทูุจุงุช ุงููุฎุฒูุฉ ุนูุฏูุง ููุฑุงู
                renderAdminOrders(allOrders);
            } else {
                alert('ุงูุฑูุฒ ุบูุท ูุง ุฑูุณ!');
            }
        }

        function renderAdminOrders(orders) {
            const activeContainer = document.getElementById('admin-orders-list');
            const archiveContainer = document.getElementById('archived-orders-list');
            
            // ููุตู ุงูุทูุจุงุช: ุงููุดุทุฉ (pending, preparing, ready) ูุงูุฃุฑุดูู (archived)
            const activeOrders = orders.filter(o => o.status !== 'archived').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const archivedOrders = orders.filter(o => o.status === 'archived').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // ุฑุณู ุงูุทูุจุงุช ุงููุดุทุฉ
            if (activeOrders.length === 0) {
                activeContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">ูุง ุชูุฌุฏ ุทูุจุงุช ูุดุทุฉ...</p>';
            } else {
                activeContainer.innerHTML = activeOrders.map(order => createOrderCard(order)).join('');
            }

            // ุฑุณู ุงูุฃุฑุดูู
            if (archivedOrders.length === 0) {
                archiveContainer.innerHTML = '<p style="text-align: center; color: #666; font-size: 0.8rem;">ุงูุฃุฑุดูู ูุงุถู</p>';
            } else {
                archiveContainer.innerHTML = archivedOrders.map(order => createOrderCard(order, true)).join('');
            }
        }

        function createOrderCard(order, isArchived = false) {
            const timeAgo = Math.floor((Date.now() - new Date(order.timestamp)) / 60000);
            
            return `
                <div class="order-card ${order.status === 'ready' ? 'ready-glow' : ''}" style="${isArchived ? 'border-color: #444; opacity: 0.8;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <span class="status-badge status-${order.status === 'pending' ? 'pending' : (order.status === 'ready' ? 'ready' : (order.status === 'archived' ? 'ready' : 'preparing'))}">
                                ${getStatusText(order.status)}
                            </span>
                            <h3 style="margin: 5px 0;">${order.customerName}</h3>
                            <p style="color: #aaa; font-size: 0.9rem;">${order.carInfo}</p>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 1.2rem;">#${getShortId(order.id)}</div>
                            <div style="font-size: 0.8rem; color: #666;">ููุฐ ${timeAgo} ุฏูููุฉ</div>
                            <div style="font-size: 0.8rem; color: var(--accent-color); margin-top: 5px;">${order.branch === 'okaz' ? 'ุนูุงุธ' : 'ุงูุญููุฉ'}</div>
                        </div>
                    </div>

                    <div style="background: #222; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 3px;">
                                <span>${item.name}</span>
                                <span>${item.price}</span>
                            </div>
                        `).join('')}
                        <div style="border-top: 1px solid #444; margin-top: 5px; padding-top: 5px; font-weight: bold; text-align: left;">
                            ุงูุฅุฌูุงูู: ${order.total} ุฑูุงู
                        </div>
                    </div>

                    ${!isArchived ? `
                    <div class="action-buttons">
                        ${order.status !== 'preparing' ? `<button onclick="updateStatus('${order.id}', 'preparing')" class="btn" style="background: #2196F3;">๐จโ๐ณ ุฌุงุฑู ุงูุชุญุถูุฑ</button>` : ''}
                        ${order.status !== 'ready' ? `<button onclick="updateStatus('${order.id}', 'ready')" class="btn" style="background: var(--success-color);">โ ุฌุงูุฒ ููุงุณุชูุงู</button>` : ''}
                        ${order.status === 'ready' ? `<button onclick="updateStatus('${order.id}', 'archived')" class="btn" style="background: #666;">๐ฅ ุฃุฑุดูุฉ</button>` : ''}
                        <button onclick="deleteOrder('${order.id}')" class="btn" style="background: var(--danger-color);">๐๏ธ ุญุฐู</button>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function getStatusText(status) {
            if (status === 'pending') return 'ุทูุจ ุฌุฏูุฏ ๐';
            if (status === 'preparing') return 'ุฌุงุฑู ุงูุชุฌููุฒ ๐ณ';
            if (status === 'ready') return 'ุฌุงูุฒ ููุงุณุชูุงู โ';
            return status;
        }

        function updateStatus(orderId, status) {
            socket.emit('update-status', { orderId, status });
        }

        function deleteOrder(orderId) {
            if (confirm('ุฃููุฏ ุชุจู ุชุญุฐู ุงูุทูุจุ')) {
                socket.emit('delete-order', orderId);
            }
        }

        // ุฏุงูุฉ ุงูุฃุฑุดูุฉ ุตุงุฑุช ูุฏูุฌุฉ ูู updateStatus ุจุชูุฑู ุงูุญุงูุฉ 'archived'

        function enableSound() {
            const audio = document.getElementById('notification-sound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                document.getElementById('sound-btn').innerText = 'โ ุงูุตูุช ููุนู';
                document.getElementById('sound-btn').style.color = '#4CAF50';
            }).catch(e => alert('ูุงุฒู ุชุถุบุท ุนุดุงู ุงููุชุตูุญ ูุณูุญ ุจุงูุตูุช'));
        }

        // ================= Socket.io Listeners (ุงูููุจ ุงููุงุจุถ) =================
        
        // ุฃูู ูุง ูุดุจูุ ูุณุชูู ุงูุทูุจุงุช ุงูููุฌูุฏุฉ
        socket.on('initial-orders', (orders) => {
            allOrders = orders; // ูุญูุธูุง ุนูุฏูุง
            if (document.getElementById('admin-dashboard').classList.contains('active')) {
                renderAdminOrders(orders);
            }
        });

        // ุชุฃููุฏ ุงุณุชูุงู ุงูุทูุจ ููุฒุจูู (ุนุดุงู ูููู ุงูููุฏููู)
        socket.on('order-confirmed', (orderId) => {
            console.log('ุชู ุชุฃููุฏ ุงูุทูุจ ูู ุงูุณูุฑูุฑ ุจุฑูู:', orderId);
            myOrderId = orderId; 
            localStorage.setItem('myOrderId', orderId); // ุญูุธ ุฏุงุฆู ูุฑูู ุงูุทูุจ
            
            // ูููู ุงูููุฏููู ููููู ูููุงุชูุฑุฉ
            const btn = document.getElementById('submit-btn');
            if (btn) {
                btn.disabled = false;
                document.getElementById('btn-text').style.display = 'inline';
                document.getElementById('btn-loader').style.display = 'none';
            }
            
            document.getElementById('invoice-id').innerText = '#' + getShortId(orderId);
            showPage('invoice-page'); // ุงูุงูุชูุงู ูููุงุชูุฑุฉ ูุญูุธ ุงูุญุงูุฉ ุชููุงุฆูุงู
        });

        // ุงุณุชูุจุงู ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ูุนูู (ููุฒุจูู)
        socket.on('order-status-update', (orderData) => {
            if (orderData.id === myOrderId) {
                updateInvoiceUI(orderData);
            }
        });

        // ููุง ูุฌู ุชุญุฏูุซ ุนูู ุงูุทูุจุงุช (ุทูุจ ุฌุฏูุฏุ ุชุบููุฑ ุญุงูุฉุ ุญุฐู)
        socket.on('order-update', (orders) => {
            console.log('ูุตู ุชุญุฏูุซ ุฌุฏูุฏ ููุทูุจุงุช:', orders.length);
            
            // ูุดูู ูู ููู ุทูุจ ุฌุฏูุฏ ุนุดุงู ูุดุบู ุงูุตูุช
            if (orders.length > allOrders.length) {
                const audio = document.getElementById('notification-sound');
                audio.play().catch(e => console.log('ูุงุฒู ุชูุงุนู ุนุดุงู ุงูุตูุช ูุดุชุบู'));
            }
            
            allOrders = orders; 
            renderAdminOrders(orders);

            // ูู ุงูุฒุจูู ูุงุชุญ ุงููุงุชูุฑุฉุ ูุญุฏุซ ุจูุงูุงุชู
            if (myOrderId) {
                const myOrder = orders.find(o => o.id === myOrderId);
                if (myOrder) {
                    updateInvoiceUI(myOrder);
                }
            }
        });

        function updateInvoiceUI(order) {
            // ููุง ูุญุฏุซ ูุงุฌูุฉ ุงููุงุชูุฑุฉ (ุงูุญุงูุฉุ ุงูุชูุงุตูู)
            // ุจูุง ุฃู ุงูุตูุญุฉ ุจุณูุทุฉ ุญุงููุงูุ ุจููุชูู ุจุชุญุฏูุซ ุงูุญุงูุฉ ูู ุฃุถููุง ุนูุตุฑ ููุง
            // ุฃู ูููู ูุถูู ุนูุตุฑ ูุนุฑุถ ุงูุญุงูุฉ ุจูุถูุญ
            const statusContainer = document.querySelector('#invoice-page .status-display');
            if (!statusContainer) {
                // ูุถูู ุนูุตุฑ ุนุฑุถ ุงูุญุงูุฉ ูู ูู ููุฌูุฏ
                const container = document.createElement('div');
                container.className = 'status-display';
                container.style.marginTop = '20px';
                container.style.padding = '15px';
                container.style.borderRadius = '8px';
                container.style.background = '#222';
                container.style.textAlign = 'center';
                
                const title = document.querySelector('#invoice-page h2');
                title.parentNode.insertBefore(container, title.nextSibling);
            }
            
            const container = document.querySelector('#invoice-page .status-display');
            container.innerHTML = `
                <h3 style="color: #aaa; margin-bottom: 10px;">ุญุงูุฉ ุงูุทูุจ:</h3>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">
                    ${getStatusText(order.status)}
                </div>
            `;
        }



    </script>
</body>
</html>
